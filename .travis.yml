language: minimal
dist: focal

sudo: required

addons:
  apt:
    packages:
      - bc
      - bison
      - build-essential
      - ccache
      - curl
      - flex
      - g++-multilib
      - gcc-multilib
      - git
      - git-lfs
      - gnupg
      - gperf
      - imagemagick
      - lib32ncurses5-dev
      - lib32readline-dev
      - lib32z1-dev
      - liblz4-tool
      - libncurses5
      - libncurses5-dev
      - libsdl1.2-dev
      - libssl-dev
      - libwxgtk3.0-gtk3-dev
      - libxml2
      - libxml2-utils
      - lzop
      - pngcrush
      - rsync
      - schedtool
      - squashfs-tools
      - xsltproc
      - zip
      - zlib1g-dev

before_install:
  - mkdir -p ~/bin
  - curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
  - chmod a+x ~/bin/repo
  - export PATH=~/bin:$PATH
  
  # Setup git-lfs
  - git lfs install

install:
  - git config --global color.ui true
  - git config --global user.email tisrijon9@gmail.com
  - git config --global user.name TISnoob
  - repo init -u https://github.com/crdroidandroid/android.git -b 14.0 --git-lfs
  
  # Run repo sync with periodic progress updates
  - |
    echo "Starting repo sync..."
    (
      repo sync --quiet > /dev/null 2> sync_errors.log &
      pid=$!
      while kill -0 $pid 2>/dev/null; do
        echo "Repo sync is still running..."
        sleep 580
      done
      if [ -s sync_errors.log ]; then
        echo "Repo sync completed with errors:"
        cat sync_errors.log
        exit 1
      fi
      echo "Repo sync completed."
    )
  
before_script:
  - export USE_CCACHE=1
  - ccache -M 50G

script:
  - |
    echo "Starting build..."
    (
      if [ -f build/envsetup.sh ]; then
        . build/envsetup.sh
        brunch lancelot > /dev/null 2> build_errors.log &
        pid=$!
        while kill -0 $pid 2>/dev/null; do
          echo "Build is still running..."
          sleep 580
        done
        if [ -s build_errors.log ]; then
          echo "Build completed with errors:"
          cat build_errors.log
          exit 1
        fi
        echo "Build completed."
      else
        echo "build/envsetup.sh not found. Please check repo sync and directory structure."
        exit 1
      fi
    )

cache:
  directories:
    - $HOME/.ccache
    - $HOME/.repo

notifications:
  email:
    recipients:
      - tisrijon9@gmail.com
    on_success: always
    on_failure: always

deploy:
  skip_cleanup: true
  provider: releases
  api_key: $GITHUB_TOKEN
  file_glob: true
  file: out/target/product/lancelot/*
  on:
    tags: false
    repo: TISnoob/rombuild
    branch: main
