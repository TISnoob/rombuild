# .travis.yml

dist: focal
language: minimal

branches:
  only:
    - master  # adjust this based on the branch you want to build

# Cache Gradle dependencies and Android SDK
cache:
  directories:
    - $HOME/.ccache
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/android-sdk/

before_install:
  - sudo apt-get update
  - sudo apt-get install -y openjdk-11-jdk git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip bc ccache libssl-dev ninja-build python3 python-is-python3 jq

# Set up environment variables
env:
  global:
    - MAKEFLAGS="-j$(nproc)"
    - USE_CCACHE=1
    - CCACHE_EXEC=$(which ccache)
    - CCACHE_DIR=$HOME/.ccache
    - GITHUB_TOKEN=$GITHUB_TOKEN  # Add your GitHub token here
    - REPO_OWNER=TISnoob  # Replace with your GitHub username
    - REPO_NAME=rombuild  # Replace with your GitHub repo name
    - DEVICE_CODENAME=lancelot # Replace with your device codename

before_script:
  - export BUILD_DIR="$HOME/rom"
  - mkdir -p $BUILD_DIR
  - cd $BUILD_DIR

# Function to keep the build alive
keepalive() {
  while true; do echo "Keeping Travis alive..."; sleep 540; done &
}

# Start the keepalive function
script:
  - keepalive
  - echo "Cloning and syncing repositories silently..."
  - git clone https://github.com/crdroidandroid/android.git -b 13.0 crdroid > /dev/null 2>&1
  - cd crdroid
  - repo init -u https://github.com/crdroidandroid/android.git -b 13.0 > /dev/null 2>&1
  - repo sync --force-sync --no-tags --no-clone-bundle --optimized-fetch --prune -j$(nproc) > /dev/null 2>&1

# Start building ROM without showing output
  - source build/envsetup.sh
  - lunch lineage_lancelot-userdebug
  - make bacon > /dev/null 2>&1

after_success:
  - echo "Build successful, preparing files for upload..."
  - cd $BUILD_DIR/crdroid/out/target/product/lancelot

  # Find the generated ROM and recovery image
  - ROM_FILE=$(ls *.zip)
  - RECOVERY_FILE=$(ls recovery.img)

  # Create a new release and upload the files to GitHub
  - echo "Uploading ROM and recovery image to GitHub Release..."
  - TAG_NAME="build-$(date +'%Y%m%d-%H%M%S')"
  - API_JSON=$(printf '{"tag_name": "%s","target_commitish": "master","name": "Build %s","body": "Automated ROM build for %s","draft": false,"prerelease": false}' $TAG_NAME $TAG_NAME $DEVICE_CODENAME)
  - UPLOAD_URL=$(curl -H "Authorization: token $GITHUB_TOKEN" -d "$API_JSON" "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases" | jq -r .upload_url | sed "s/{?name,label}//")

  # Upload the ROM zip
  - curl -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/zip" --data-binary @$ROM_FILE "$UPLOAD_URL?name=$(basename $ROM_FILE)"

  # Upload the recovery image
  - curl -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/octet-stream" --data-binary @$RECOVERY_FILE "$UPLOAD_URL?name=$(basename $RECOVERY_FILE)"

after_failure:
  - echo "Build failed."

notifications:
  email:
    recipients:
      - tisrijon9@gmail.com
    on_success: change
    on_failure: always
