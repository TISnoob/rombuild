language: minimal
dist: focal

sudo: required

addons:
  apt:
    packages:
      - bc
      - bison
      - build-essential
      - ccache
      - curl
      - flex
      - g++-multilib
      - gcc-multilib
      - git
      - git-lfs
      - gnupg
      - gperf
      - imagemagick
      - lib32ncurses5-dev
      - lib32readline-dev
      - lib32z1-dev
      - liblz4-tool
      - libncurses5
      - libncurses5-dev
      - libsdl1.2-dev
      - libssl-dev
      - libwxgtk3.0-gtk3-dev
      - libxml2
      - libxml2-utils
      - lzop
      - pngcrush
      - rsync
      - schedtool
      - squashfs-tools
      - xsltproc
      - zip
      - zlib1g-dev

before_install:
  - mkdir -p ~/bin
  - curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
  - chmod a+x ~/bin/repo
  - export PATH=~/bin:$PATH
  
  # Setup git-lfs
  - git lfs install
  
install:
  - git config --global color.ui true
  - git config --global user.email tisrijon9@gmail.com
  - git config --global user.name TISnoob
  - repo init -u https://github.com/crdroidandroid/android.git -b 14.0 --git-lfs
  
  # Perform repo sync with minimal logging and progress updates
  - |
    echo "Starting repo sync..."
    (
      repo sync --quiet --no-tags > sync.log 2>&1 &
      pid=$!
      # Periodically log status with minimal information
      while kill -0 $pid 2>/dev/null; do
        echo "Repo sync is running..." >> sync.log
        sleep 600  # Check every 10 minutes
      done
      # Output the final part of the log if necessary
      tail -n 100 sync.log
    )

before_script:
  - export USE_CCACHE=1
  - ccache -M 50G

script:
  - . build/envsetup.sh
  - lunch lineage_lancelot-userdebug
  - mka bacon > /dev/null 2>&1 || true  # Continue even if the build command fails
  - echo "Build script finished"  # Dummy command to keep the build process alive

cache:
  directories:
    - $HOME/.ccache
    - $HOME/.repo

notifications:
  email:
    recipients:
      - tisrijon9@gmail.com
    on_success: always
    on_failure: always

deploy:
  skip_cleanup: true
  provider: releases
  api_key: $GITHUB_TOKEN
  file_glob: true
  file: out/target/product/lancelot/*
  on:
    tags: false
    repo: TISnoob/rombuild
    branch: main
